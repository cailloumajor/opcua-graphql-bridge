version: "3.8"

services:
  integration-tests:
    build:
      context: ../..
    command:
      - /bin/bash
      - -c
      - |
        . .venv/bin/activate
        pip install micropipenv[toml]
        pip install -r <(micropipenv requirements \
          --method poetry \
          --no-hashes \
          --no-default \
          --no-comments \
          --no-indexes \
          | grep -E '(pytest|requests|websocket-client|yarl)=')
        pytest -vv tests/integration
    depends_on:
      - centrifugo
      - influxdb
      - opc-server
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    init: true
    volumes:
      - ..:/app/tests:ro

  opc-server:
    build: ./opc_server

  influxdb:
    image: influxdb:1.8
    tty: true

  centrifugo:
    image: centrifugo/centrifugo:v2.6
    environment:
      - CENTRIFUGO_V3_USE_OFFSET=true
      - CENTRIFUGO_API_KEY=apikey
      - CENTRIFUGO_CLIENT_INSECURE=true
      - CENTRIFUGO_HEALTH=true
      - CENTRIFUGO_HISTORY_LIFETIME=60
      - CENTRIFUGO_HISTORY_SIZE=10
      - CENTRIFUGO_PROXY_SUBSCRIBE=true
      - CENTRIFUGO_PROXY_SUBSCRIBE_ENDPOINT=http://integration-tests:8008/centrifugo/subscribe
    tty: true
