version: "3.8"

services:
  integration-tests:
    build:
      context: ../..
    image: opcua-webhmi-bridge:integration-tests
    command:
      - /bin/bash
      - -c
      - |
        . .venv/bin/activate
        pip install micropipenv[toml]
        pip install -r <(micropipenv requirements \
          --method poetry \
          --no-hashes \
          --no-default \
          --no-comments \
          --no-indexes \
          | grep -E '(pytest|requests|websocket-client|yarl)=')
        pytest -vv tests/integration
    depends_on:
      - centrifugo
      - influxdb
      - opc-server
    environment:
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
    init: true
    volumes:
      - ..:/app/tests:ro

  opc-server:
    build: ./opc_server

  influxdb:
    image: influxdb:1.8
    tty: true

  centrifugo:
    image: centrifugo/centrifugo:v2.6
    command: centrifugo --config config.toml
    tty: true
    volumes:
      - ./centrifugo.toml:/centrifugo/config.toml:ro
